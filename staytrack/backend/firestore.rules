rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // -------------------------------------------------------------
    // Helper Functions
    // -------------------------------------------------------------
    function isOwner() {
      return request.auth != null && request.auth.token.role == 'owner';
    }
    
    function isAdmin() {
      return request.auth != null && request.auth.token.role == 'admin';
    }

    function isStaff() {
       return isOwner() || isAdmin();
    }

    // -------------------------------------------------------------
    // Collections
    // -------------------------------------------------------------

    // Owners: Only accessible by owners themselves or super admins
    match /owners/{ownerId} {
      allow read, write: if isOwner() && request.auth.uid == ownerId;
    }

    // Admins: Only accessible by other admins or owners
    match /admins/{adminId} {
      allow read, write: if isStaff();
    }

    // Rooms: Only staff can manage rooms
    match /rooms/{roomId} {
      allow read: if isStaff();
      allow write: if isOwner(); // Only owner can add/remove rooms? or Admins too?
    }

    // Complaints: Staff can read/update all complaints
    match /complaints/{complaintId} {
      allow read: if isStaff();
      allow update: if isStaff(); // To update status
      allow create: if false; // Students create via THEIR app, not this admin portal ruleset (which assumes staff context)
      allow delete: if isOwner();
    }

    // Students / Tenants: Staff can manage student data
    match /students/{studentId} {
      allow read, write: if isStaff();
    }
    
    // Allocations: linking students to rooms
    match /allocations/{allocationId} {
      allow read, write: if isStaff();
    }

    // Logs: Read-only for staff, write only via backend functions usually
    match /activity_logs/{logId} {
      allow read: if isStaff();
      allow write: if false; // Should be written by server-side functions
    }
  }
}
