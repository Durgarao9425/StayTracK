# StayTrack Technical Documentation

## 1. Firestore Data Structure

We store student data in the `students` collection.

### Collection: `students`
Document ID: Auto-generated by Firestore (or manual UUID)

**Fields:**
```json
{
  "id": "student_document_id",
  "name": "John Doe",
  "phone": "9876543210",
  "parentPhone": "9876543211",
  "adhaar": "123456789012",
  "room": "A-101",
  "bed": "1",
  "rent": "5000",
  "feeStatus": "Pending",
  "createdAt": "2023-10-27T10:00:00.000Z",
  
  // Image URLs (from Firebase Storage)
  "profileImage": "https://firebasestorage.googleapis.com/...",
  "aadharFrontImage": "https://firebasestorage.googleapis.com/...",
  "aadharBackImage": "https://firebasestorage.googleapis.com/..."
}
```

## 2. Firebase Storage Structure

Images assume the following hierarchy:
- `students/{studentId}/profile.jpg`
- `students/{studentId}/aadhar_front.jpg`
- `students/{studentId}/aadhar_back.jpg`

## 3. Security Rules

### Development Rules (Open Access)
*Use only during initial development.*

**Firestore:**
```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if true;
    }
  }
}
```

**Storage:**
```javascript
rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    match /{allPaths=**} {
      allow read, write: if true;
    }
  }
}
```

### Production Rules (Secure)
*Deploy these before launching.*

**Firestore:**
```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Students Collection
    match /students/{studentId} {
      // Allow read/write only if authenticated
      allow read, write: if isAuthenticated();
      
      // Optional: Add role-based access control
      // allow write: if isAuthenticated() && request.auth.token.role == 'admin';
    }
  }
}
```

**Storage:**
```javascript
rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    match /students/{studentId}/{imageId} {
      // Only allow authenticated users to upload/read
      allow read, write: if request.auth != null;
      
      // Allow only images
      allow write: if request.resource.contentType.matches('image/.*')
                   && request.resource.size < 5 * 1024 * 1024; // 5MB limit
    }
  }
}
```

## 4. Helper Functions

### `uploadFile(uri, path)`
Located in `src/services/storage.js`.
- Accepts a local file URI and a target storage path.
- Handles blob conversion and upload.
- Returns the download URL.

### `handleSaveStudent` flow
Located in `src/screens/Owner/Students.js`.
1.  Validates form inputs.
2.  Generates a new Firestore Document Reference to get an ID.
3.  Uploads Profile, Aadhar Front, and Aadhar Back images to storage using the generated ID.
4.  Constructs student object with image URLs.
5.  Saves document to Firestore.
